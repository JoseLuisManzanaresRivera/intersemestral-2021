---
title: "Sesión 2 viernes 9 Septiembre"
author: "JLMR"
date: 2022-09-04T22:13:14-05:00
output: html_document
---

```{r set-global-options, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      cache = FALSE,
                      include = TRUE,
                      collapse = FALSE,
                      dependson = NULL,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = FALSE)                     

```



```{r silent-packages, echo = FALSE, eval = TRUE, message=FALSE, include = FALSE}

library(ggrepel)
library(tidyverse)
library(scales)
library(ggpubr)
library(plotly)
library(foreign)
library(datagovindia)
```

## Objetivos: 

Estudiar las medidas de tendencia central y dispersión.    

### Meta de aprendizaje: 
Implementar la estimación y representar visualmente las estimaciones usando R, Python. 

#### Contexo:  
Estadística descriptiva.


#### Definiciones.


Una pregunta básica para entender un fenómeno a escala regional es 

¿Qué tan frecuente ocurre un suceso? 

Por ejemplo podemos estar interesados en comprender la distribución del ingreso.

¿ Cuál es el ingreso promedio en México?

Estas y otras preguntas requieren del análisis de datos  y las medidas de tendencia centrla nos ayudan a obtener esta información.

### Media

El dato representativo, el promedio. *Notación:*

$$\bar{x}=\frac{1}{n} (\sum_{i=1}^{n} x_i) =\frac{x_1 +x_2+...+x_n}{n}$$


Ejemplo  1

```{r}

# Defining vector
x <- c(3, 7, 5, 13, 20, 23, 39, 23, 40, 23, 14, 12, 56, 23)

# Print mean
print(mean(x))
```


Para estimación en puthon See [**ipynb**](/Sesión2_Tendencia central)


### Mediana.

El valor que se localiza en la mitad de los datos. 


Una medida de tendencia central que es util cuando los datos tienen sesgo, ej. cuando la media y la mediana no son iguales.
 
Ejemplo 3

```{r}
 # Defining vector
x <- c(3, 7, 5, 13, 20, 23, 39,
	23, 40, 23, 14, 12, 56, 23)

# Print Median
median(x)
```




## Moda

```{r}

# Defining vector
x <- c(3, 7, 5, 13, 20,  39, 23, 40,
	23, 14, 12, 56, 23, 29, 56, 37,
	45, 1, 25, 8, 56, 56)

# Generate frequency table
y <- table(x)

# Print frequency table
print(y)

# Mode of x

moda <- names(y)[which(y == max(y))]

# Print mode
print(moda)
```

Implementación en **R**


Dad un conjunto de datos cualquiera, podemos determinar las medidas de tendencia central aplicando la función (verbo) **summary** sobre el objeto (data frame deseado  -sustantivo-).




### Ejempo 1 Estimación de medidas de tendencia central básicas. 

#### Datos: Correlación entre Salario medio y participación de la Mujer por categoria de ocupación.


Conocer como se comporta el salario percibido entre un grupo de egresados universitarios de diversas disciplinas. La base de datos contiene diversas caracteristicas de la población de estudio incluido el salario (una varible numérica ordinal) y la variable que describe la disciplina en la que trabaja el individuo. 


La idea es estimar los salarios promedio, así como representar graficamente el comparativo entre ocupaciones.

```{r, include=FALSE}

# install.packages("datagovindia")


url<-"https://github.com/bordercode/STATISTICS-I-MDR/blob/main/content/english/blog/graduados.rds?raw=true"

ejercicio_1<-read_rds_from_github(url)

```

```{r, message = FALSE, warning = FALSE, fig.width=10, fig.height=6, echo= TRUE}

theme_set(theme_light())

# Cargamos los datos.
# get data using code chunk above.

## from url

url_grad<-("https://github.com/JoseLuisManzanaresRivera/intersemestral-2021/blob/main/content/post/graduados.rds?raw=true")

ejercicio_grad<-read_rds_from_github(url_grad)


## Local  load 

graduados<-readRDS("graduados.rds")




# Exploración básica para conocer la estructura.

glimpse(graduados)

# Tipo de estructura de datos: Corte transversal (un momento en el tiempo).

# Con 64 observaciones. 21 variables.  Este formato de observacion por renglon y variable por columna lo denominaresmo -tidy data- o datos organizados con estructura estándar.

# Visualización  Scatter con trend para  4 features.  X= Proporcion mujeres/hombres por categoria, Y=mediana del salario, Categoria en color y otra Categoria en point size.

## Observamos variables numéricas, (denotadas int o dbl según sean numeros enteros o decimales), categóricas (denotadas fct).  Otro tipo de datos que no esta presente paro es comun es chr, (string de texto, ejemplo nombre de países, calles, etc.)


# Alternativa  para conocer la estructura de datos. Desventaja si son muchas variables es una gran tabla. 

str(graduados)

# Medidas de tendencia central y estadistica descriptiva básica.
summary(graduados)


 g<-ggplot(graduados,aes(ShareWomen,Median, color=Area,size=Sample_size, label=Major))+
  geom_point()+
  geom_smooth(aes(group=1),method = "lm")+
  expand_limits(y=0)+
  scale_color_brewer(palette="Dark2")+
  scale_y_continuous(labels=dollar_format())+
  scale_x_continuous(labels=percent_format())+
  labs(x="Mujeres/Hombres", y="Salario Medio  US$")+
    theme(legend.position="botton")
  
  ggplotly(g)

```


**Nota**: Como parte del proceso de los datos no solo estimamos la media  pero desplegamos una herramienta de viasualización denominado **Diagrama de Dispersión** que en este caso es **bi-variada** 

Con la libreria ggplot de R podemos tambien representar este conjunto de datos  mediante el  diagrama de dispersión incorporando mas dimensiones (no solo el salario y la proporción entre mujeres y hombres), pero también la categoria a la que corresponde la ocupación y el tamaño de la muestra, Lo anterior permite extraer una gran cantidad de información para perfilar alguna explicación o hipotesis sobre el fenómeno.  Estamos describiendo los datos, estamos haciendo análisis exploratorio de datos!

## Medidas de Dispersón: 

#### Representación gráfica de la frecuencia.


Un punto de partida básico es mediante la exploración de la frecuencia. Veamos como podemos generar un tabla de frecuancia para conocer la distribución de un conjunto de datos hipotérico:
 
 
 
```{r}
# Defining vector
x <- c(3, 7, 5, 13, 20, 23, 39, 23, 40,
	23, 14, 12, 56, 23, 29, 56, 37,
	45, 1, 25, 8, 56, 56)

# Generate frequency table
y <- table(x)

# Print frequency table
print(y)

```


Podemos representar esta información mediante diversas visualizaciónes: Tres de las mas importantes son los **Histogramas**, las funciones de Densidad y el box plot.


### Histograma

Esta es una representación   visual que integra la frecuencia con la ocurre una determinada observación. (Nota: representación discreta no contínua) 

Se compone por la suma de la frecuencia observada entre grupos predefinidos.




**Contexto**. Creación de histograma para representar la frecuencia de los datos. 

```{r, include=FALSE, echo = FALSE, warning = FALSE}

N16<-readRDS("N16.rds")
glimpse(N16)

p220<-select(N16,cve_cie, ent_nac, con_indm,aten_pren,niv_escol,sexoh,tallah,pesoh,apgarh,silverman,procnac,edad_madre )%>%
  mutate(sdr=ifelse(cve_cie=="P220"|cve_cie=="P229",1,0), sexoh=as.factor(sexoh))%>%
filter(pesoh!=9999, tallah!=99,sdr==1, sexoh!=9,edad_madre!=999, procnac!=9&procnac!=3&procnac!=8&procnac!=4, apgarh<=10, silverman<=10)%>%
  mutate(proc_n=ifelse(procnac==1,"Eutócico","Cesárea"))%>%
  rename(Procedimiento=proc_n)


p220_no_sdr<-select(N16,cve_cie, ent_nac, con_indm,aten_pren,niv_escol,sexoh,tallah,pesoh,apgarh,silverman,procnac,edad_madre )%>%
  mutate(sdr=ifelse(cve_cie=="P220"|cve_cie=="P229",1,0), sexoh=as.factor(sexoh))%>%
filter(pesoh!=9999, tallah!=99,sdr!=1, sexoh!=9,edad_madre!=999, procnac!=9&procnac!=3&procnac!=8&procnac!=4, apgarh<=10, silverman<=10)%>%
  mutate(proc_n=ifelse(procnac==1,"Eutócico","Cesárea"))%>%
  rename(Procedimiento=proc_n)


h1<-ggplot(p220, aes(x=pesoh)) + geom_histogram(fill="white", colour="black") +
facet_grid(Procedimiento~ .)+xlab("Peso (gramos)")+ylab("Casos")

h2<-ggplot(p220, aes(x=pesoh, fill=Procedimiento)) +
geom_histogram(position="identity")+
xlab("Peso (gramos)")+ylab("Casos")+
scale_fill_manual(values=c("grey70", "grey20"))

```

```{r,echo= FALSE, fig.height = 8, fig.width = 12, warning=FALSE, message=FALSE}
h1
```

```{r,echo= FALSE, fig.height = 8, fig.width = 12, warning=FALSE, message=FALSE}
h2
```



Importante: La forma del histograma permite (en cuanto a su simetría) permite informar sobre el sesgo de los datos. En la figura siguiente se observan dos esenarios relevantes: Sesgo positivo  y negativo. En ambos casos la implicación sobre el supuesto de normaliad de los datos. 

Una particularidad adicional es que en ausencia de **normalidad**  (un concepto que revisaremos en la sesión sobre distribuciones de probabilidad) de los datos las medidas de tendencia central **media** y **mediana** difieren.


![](/img/qq1.jpg)

### KDF Función Kernel de densidad.

Permite la representación de la districuión considerando una aproximación contínua,no discreta como es el caso del histograma. 

Notación: 
![](/img/kernelDF.jpg)
Donde **K** es una función, usualmente la distribución normal (distribución con  $$\mu=0$$ y $$\sigma=1$$).

En notación esto es: 
$$K(x)=\phi (x)$$ con $\phi$ como la distribución normal.


**h** representa el ancho de clase y toma un valor positivo. $$[0,\infty]$$ Es un parámetro que puede modificarse para generar una distribución con mayor o menor suavidad en la curva. 

Los extremos o limites para **h** son 0, con una curva de densidad sin suavidad e infinito totalmente plana. 

Ejemplo. 

![](/img/kernelnormal.jpg)

**Ejemplo 1** Estimación de funcion de densidad para representar la frecuencia de datos para variables numéricas  y su visualización  por categorias. 
Herramienta de visualización: **ggplotly**.  Funciones aplicadas: **ggplot** **geom_density**.

Contexto de la base de datos. Data frame en formato rds que contiene Edad de  pacientes positivos por covid y edad de defunción en México. Año 2020.

#### Cálculo función de densidad, representación de medidas de tendencia central  y distribución para detectar diferencias de edad.

```{r, echo= FALSE, fig.height = 5, fig.width = 8.5}

## Source: https://www.gob.mx/salud/documentos/coronavirus-covid-19-comunicado-tecnico-diario-238449

agedf<-readRDS("agedf.rds")


dp<-ggplot(agedf, aes(x=edad, fill=sex))+
geom_density(alpha=.2)+  
labs(color="Sex")+
xlab("Patient age  (years)")+
ylab("Density  f(y)")+
theme_classic()+
scale_fill_discrete(labels=c("Female", "Male"))+
geom_vline(xintercept =mean(agedf$edad), linetype="dotted", color="red")+
annotate("text", x=32, y=.005, size=2,label="Mean patient age")+ theme(legend.title=element_blank())

ggplotly(dp)
```
**Ejemplo 2**  Distribución de edades para defunción por covid en México. 
Funciones estudiadas (Verbos tidyverse aplicados): Filter, select, mutate, summarise. ggplot 

```{r, echo= FALSE}

open<-readRDS("open.rds")

def<-filter(open, resultado==1)%>%
  filter(fecha_def!="9999-99-99")%>%
  select(sexo, edad)
def$sexo[def$sexo == "1"] <- "Female"
def$sexo[def$sexo == "2"] <- "Male"  
def<-mutate(def,sexo=as.factor(sexo))

fmean<-filter(def, sexo=="Female")%>%
  mutate(varmean=mean(edad))%>%
   summarise(mean=mean(varmean))

mmean<-filter(def, sexo=="Male")%>%
  mutate(varmean=mean(edad))%>%
   summarise(varmean=mean(varmean))

  
p<-ggplot(def, aes(x=edad, fill=sexo))+
geom_density(alpha=.2)+  
labs(color="Sex")+
xlab("Person age  (years)")+
ylab("Density  f(y)")+
theme_classic()+
scale_fill_manual(values = c("brown","blue4"))+
geom_vline(xintercept = fmean$mean, linetype="dotted", color="purple")+
geom_vline(xintercept = mmean$varmean, linetype="dotted", color="blue")+
annotate("text", x=44, y=.005, size=3,label="Mean person age")+ theme(legend.title=element_blank())


ggplotly(p)
```


**Ejemplo  3** Función de densidad para dos categorias. 
Funciones estudiadas: group_by, rename, left_join, filter, select, mutate, summarise. ggplot 

####  Caso Aguascalientes


```{r,  fig.height = 8, fig.width = 12,  message=FALSE, warning=FALSE, echo=FALSE}


sdensity<-readRDS("density.rds")%>%
  mutate(s=as.factor(s))%>%
  filter(ENT_RESID!=33& ENT_RESID!=34& ENT_RESID!=35& ENT_RESID!=99)%>%
  group_by(ENT_RESID)

cat_e<-read.csv("cat_entidad.csv")%>%
select(-X)%>%
rename(ent_res=X.U.FEFF.EDO)%>%
mutate(ent_res=sprintf("%02d",ent_res))%>%
mutate(ENT_RESID=as.factor(ent_res))%>%
select(-ent_res)

sdensity<-left_join(sdensity,cat_e)



ags<-filter(sdensity,ENT_RESID=="01")%>%
  mutate(s=as.factor(s))


aplt<-ggplot(ags, aes(x=age,linetype=s, color=s))+
geom_line(stat="density")+
labs(linetype="Causa")+
xlab("Edad de la persona (Años)")+
ylab("Densidad f(y)")+
annotate("segment", x=29, xend=13, y=0.011, yend=0.011,  size=.3, arrow=arrow(length=unit(.2,"cm")))+
annotate("text", x=23, y=0.013, label="Alta incidencia")+
annotate("text", x=21, y=0.009, label="13<Edad<29")+
annotate("rect", xmin=13, xmax=29, ymin=0, ymax=0.03, alpha=.1,fill="black")+
scale_linetype(labels=c("Otras causas","Suicidio"))+
theme_classic()+
scale_color_manual(values = c("mediumturquoise","magenta1"))+
theme(legend.position="none")


aplt

```


**Ejemplo 4** Función de densidad multiples bases de datos. (32 estados de México).
Herramienta de análisis: stat=density 

Funciones estudiadas: **facet_wrap**

```{r,  fig.height = 8, fig.width = 12, message=FALSE, warning=FALSE, echo =FALSE}


mxplt<-ggplot(sdensity, aes(x=age,linetype=s, color=s))+
geom_line(stat="density")+
labs(linetype="Causa")+
xlab("Edad de la persona (Años)")+
ylab("Densidad f(y)")+
facet_wrap(~DESCRIP, nrow=6)+
scale_linetype(labels=c("Otras causas","Suicidio"))+
  theme_classic()+
scale_color_manual(values = c("mediumturquoise","magenta1"))+
  theme(legend.position="none")

mxplt
```

#### ECDF Función de densidad acumnulativa empírica.

Conocer la frecuencia es importante pero muy amenudo necesitamos conocer que proporción de nuestras observaciones se ubica por debajo de un cierto umbral.  
Para este propósito es muy útil estimar la frecuencia acumulada. Una representación contínua de este concepto es mediante la funicion de densidad empírica acumulada que además en su implementación en Python nos permite observar el porcentaje de datos en el eje de las ordenadas al origen. 



#### Rango

La diferencia entre el dato maximo u el mínimo.

Es común estimar el rango intercuartil que marca la distancia entre el dato en el percentil 25 y el 75.. Formalmente el percentil 25 se denomina cuartil Q1  y el percentil 75 se denomina cuartil 3 o Q3. 

#### Boxplot.


**Contextualización:** Contraste entre la distribución de grupos,  identificación de outliers y permite hbicar  el reango inter cuartil y la mediana.

Esta representación visual de la distribución es generalemtne utilizada para la representación de **variables categóricas**.

Note que los upper nad lower fences o whiskers, se extienden por definición en u rango de +/- 1.5 IQ, pero la representación considera los puntos más alejados dentro de este rango, es decir , puede ser que el rango sea mayor a la ubicación concreta de los puntos en cada lado, es por ello que los fences comunmente son asimétricos.

### Representación de dispersión datos con frecuencia diaria. Boxplot

[Datos  site:](https://smn.conagua.gob.mx/es/climatologia/informacion-climatologica/normales-climatologicas-por-estado)
[Source alternariva](http://atlasclimatico.unam.mx/RRDM/)


![](/img/explicacion_bxplt.jpg)


**Ejemplo 1**  Estimación de box plot para examinar la distribución de una variable. Inclusión de solo una categoría. Distribución de temperaturas mínimas diarias registradas en estación metereológica DGO10092 del SMN. Periodo 1941 -2000.

```{r,  fig.height = 8, fig.width = 12, include=FALSE, echo = FALSE, warning = FALSE}

dgo_temp<-readRDS("dgo_temps.rds")

## Damos un vistazo a los datos para comprobar que las variables  estan en el formato apropiado para su análisis.

glimpse(dgo_temp)
str(dgo_temp)

## Notamos que la variable FECHA no esta declarada como clase "date", necesitamos hacer un mutate para corrgir esto antes de su uso.  
#Tip: Usamos la función as.Date respetando el orden de los datos como día, mes, año !!

DGO<-dgo_temp%>%mutate(date=as.Date(FECHA, "%d/%m/%Y"))%>%
mutate(ms=as.integer(substr(FECHA,4,5)),año=substr(FECHA,7,10))

## Creamos un data frame con dos variables: mes con el nombre del mes  y ms con el número del mes para agregarlo a la base original. Esto será necesario para su representación gráfica. 

meses<-data.frame(mes=c("Enero ",	"Febrero",	"Marzo",	"Abril",	"Mayo",	"Junio",	"Julio",	"Agosto",	"Septiembre",	"Octubre",	"Noviembre",	"Diciembre"),ms=seq(1, 12, by=1))


### Usamos la función left_join para unir las dos bases de datos (data frames). 

DGO<-left_join(meses,DGO)
glimpse(DGO)
levels(DGO$mes )
write.csv(DGO, "dgo_temp.csv")

## Plot Daily  1941-2000

boxplot<-ggplot(DGO,aes(x=fct_inorder(mes),y=tmin))+
geom_boxplot()+
xlab("Mes")+ylab("Temperatura diaria mínima°c")+
theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1))
```
#### Distribución de temperaturas mínimas  diarias registradas en estación metereológica DGO10092   del SMN. Periodo 1941 -2000. 
```{r, warning = FALSE}
boxplot
```

**Ejemplo 2:** 
Determinación de Media, rango intercualtil y percentiles 1 y 3 (q25 y q75). Representación con boxplot para variables tipo categoricas. 


```{r,  fig.height = 8, fig.width = 12, include=FALSE,  echo = FALSE, warning = FALSE}

BC2001<-read.csv("ema_2001_AGUACALIENTE.csv")%>%
  rename(max=tmin,min=tmax)

df<-BC2001%>%
mutate(max=as.numeric(as.character(max)),min=as.numeric(as.character(min)) )

temp<-mutate(df,date=as.Date(FECHA, "%d/%m/%Y"))%>%
mutate(mes=as.integer(substr(FECHA,4,5)),año=substr(FECHA,7,10))

tidy<-gather(temp, tipo, temperatura, max:min)


meses<-data.frame(Meses=c("Enero ",	"Febrero",	"Marzo",	"Abril",	"Mayo",	"Junio",	"Julio",	"Agosto",	"Septiembre",	"Octubre",	"Noviembre",	"Diciembre"),mes=seq(1, 12, by=1))


tidy_<-left_join(tidy,meses)

boxplot_2<-ggplot(tidy_, aes(x=fct_inorder(Meses), y=temperatura)) + geom_boxplot(aes(fill=tipo))+
xlab("Mes")+
ylab("Temperatura diaria máxima y mínima°c")+
theme_light()+
theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1))
levels(tidy_$Meses )


```


```{r, warning = FALSE,message=FALSE, echo=FALSE}
library(plotly)
ggplotly(boxplot_2)
```





![](/img/d.jpg)

*Docucmentación adicional con ejemplos de repaso* [boxplot](http://www.cookbook-r.com/Graphs/Plotting_distributions_(ggplot2)/)

### Varianza

El valor promedio de las desviaciones de cada elemento *i*  respecto a la media.


$$V(X)= Var(X)=\sigma^2_{X}$$

$$\sigma^2_{X}=E[(X-\mu)^2]$$
$$\sigma^2_x = \frac{1}{n}\sum_{i=1}^{n}(x_i - \bar{X})^2$$

La varianza es una referencia importante para determinar la dispersión de un conjunto de datos. Sin embargo, cuando queremos comparar las dispersión entre conjuntos de datos una deventaja de la varianza es que esta exprezada en **unidades al cuadrado**.  Es una medida de dispersión que depende de la escala de medición.


Esta desventaja la resuelve la desviación estándard que es una medida independiente de la escala.  Por este motivo la medida de dispersión clásica que utilizaremos para comparar dispersión de los datos es la **desviación estádard**. 

### Desviación estándard. 

Raíz cuadrada de la varianza.

$$\sqrt{\sigma^2} = \sqrt{\frac{1}{n}\sum_{i=1}^{n}(x_i - \bar{X})^2}=\sigma$$


Asociado a esta medida podemos calcular **el coeficiente de variación** que solo añale la relación  de esta dispersión, medida por la desviación estándard respecto a la media. Este coeficiente se ubica en el rango 0-1 frecuentemente, pero en algunas distribuciones puede superar la unidad. 
$$cv=\frac{\sigma_x}{|\bar{X}|}$$
En términos generales entre vayor es el cv, tenemos una mayor dispersión en los datos. 




## Actividad 


Con los datos sobre temperatura disponibles sobre la temperatura por la estación meteorológica  en Tijuana, determine: 

+ ¿Qué valor toma la media, la mediana, Q1, Q3 y cuál es el rando intercuartil?

+ ¿Qué año presenta la mayor precipitación?




```{r}
url_tij<-("https://github.com/JoseLuisManzanaresRivera/intersemestral-2021/blob/main/content/post/precip_tijuana.csv?raw=true")

practica<-read_rds_from_github(url_tij)%>%
  na.omit()
```

```{r, include=FALSE}

### Paso 1 
precip<-group_by(practica,año)%>%
  summarise(mes=sum(mesp))

### Paso 2

summary(precip)
glimpse(precip)

## Convertimos variable año de Chr string a numérica.
precip<-mutate(precip,año=as.numeric(año))

### paso 3 plot Representación en line plot. 

plt<-ggplot(precip, aes(x=año, y=mes))+
geom_line(size=.3, colour="gray")+
geom_smooth()+
xlab("Año")+
ylab("Precipitación  promedio. 1969-2012 (mm)")+
theme_light()+
geom_hline(yintercept = 185.2, size=.5, linetype="dashed",color='red')+
geom_hline(yintercept = 343.5, size=.5, linetype="dashed",color='darkblue')


```


```{r,message=FALSE, include= FALSE, echo=FALSE}
ggplotly(plt)
```


